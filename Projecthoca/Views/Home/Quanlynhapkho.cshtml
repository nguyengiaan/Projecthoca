@{
    Layout = "_Layout";
}

@model Projecthoca.Models.EnitityVM.DanhmucVM
<link href="~/css/quanlynhapkho.css" rel="stylesheet" />
<style>
    .container {
        display: flex;
        justify-content: space-between;
        /* Căn chỉnh các phần tử nằm kế bên nhau */
    }


    .form-container {
        flex: 1;
        padding-right: 20px;
        /* Khoảng cách giữa phần tử form và danh sách */
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input {
        width: 100%;
        /* Đảm bảo ô input rộng đầy */
        padding: 8px;
        box-sizing: border-box;
    }

    .form-group1 {
        flex: 1;
        padding-left: 20px;

    }

    .search-container {
        margin-bottom: 15px;
    }

    .search-container input {
        width: 100%;
        /* Đảm bảo ô input tìm kiếm rộng đầy */
        padding: 8px;
        box-sizing: border-box;
    }

    .table-container {
        margin-top: 15px;
    }

    .table-container table {
        width: 100%;
        /* Đảm bảo bảng rộng đầy */
        border-collapse: collapse;
    }

    .table-container th,
    .table-container td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    .table-container th {
        background-color: #f2f2f2;
    }

    /* Nút chính */
    #submitBtnpn {
        background-color: #007bff;
        /* Màu nền chính */
        color: white;
        /* Màu chữ */
        border: none;
        /* Không viền */
        padding: 10px 20px;
        /* Khoảng cách bên trong */
        font-size: 16px;
        /* Kích thước chữ */
        border-radius: 5px;
        /* Bo góc */
        cursor: pointer;
        /* Con trỏ khi di chuột qua */
        transition: background-color 0.3s ease, transform 0.2s ease;
        /* Hiệu ứng chuyển màu và phóng to */
    }

    #submitBtnpn:hover {
        background-color: #0056b3;
        /* Màu nền khi di chuột qua */
        transform: scale(1.05);
        /* Phóng to nhẹ khi di chuột qua */
    }

    /* Nút phụ */
    #closeBtn {
        background-color: #6c757d;
        /* Màu nền phụ */
        color: white;
        /* Màu chữ */
        border: none;
        /* Không viền */
        padding: 10px 20px;
        /* Khoảng cách bên trong */
        font-size: 16px;
        /* Kích thước chữ */
        border-radius: 5px;
        /* Bo góc */
        cursor: pointer;
        /* Con trỏ khi di chuột qua */
        transition: background-color 0.3s ease, transform 0.2s ease;
        /* Hiệu ứng chuyển màu và phóng to */
    }

    #closeBtn:hover {
        background-color: #5a6268;
        /* Màu nền khi di chuột qua */
        transform: scale(1.05);
        /* Phóng to nhẹ khi di chuột qua */
    }
</style>
<div class="modal fade" id="Themphieunhap" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" id="formtong" style="max-width: 90%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm phiếu nhập</h5>
                
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="form-container">
                        <form id="formnhapkho" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="Ma_danhmuc">Mã danh mục</label>
                                <input asp-for="Ma_danhmuc" type="text" id="Ma_danhmuc" readonly>
                            </div>
                            <div class="form-group position-relative">
                                <label for="Ten_danhmuc">Tên sản phẩm</label>
                                <input asp-for="Ten_danhmuc" type="text" id="Ten_danhmuc" oninput="filterDanhMucList()"
                                    placeholder="Nhập tên danh mục..." autocomplete="off">

                                <!-- Danh sách danh mục -->
                                <div id="danhMucList" class="dropdown-menu" style="display: none; width: 100%;">
                                    <table class="table table-hover">
                                        <tbody id="tblbody"></tbody>
                                    </table>
                                </div>
                            </div>


                            <div class="form-group">
                                <label for="Gia">Giá</label>
                                <input asp-for="Gia" type="text" id="Gia">
                            </div>
                            <div class="form-group">
                                <label for="Soluong">Số lượng</label>
                                <input type="number" id="Soluong">
                            </div>
                            <div class="form-group">
                                <label for="Donvitinh">Đơn vị tính</label>
                                <input asp-for="Donvitinh" type="text" id="Donvitinh">
                            </div>
                            <button type="button" id="btnThemVaoBangModal" class="btn btn-success">Thêm vào
                                bảng</button>
                        </form>

                    </div>
                    <div class="form-group1">
                        <div class="search-container">
                            <input type="text" id="TenSanPham" onkeyup="searchProduct()"
                                placeholder="Tìm kiếm sản phẩm...">
                        </div>
                        <div class="table-container">
                            <h5>Danh sách danh mục</h5>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Mã sản phẩm</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Đơn vị tính</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                        <th>Xóa</th>
                                        <th>Sửa</th>
                                    </tr>
                                </thead>
                                <tbody id="tblbodyModal">
                                    <!-- Dữ liệu sẽ được thêm vào đây bởi JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="submitBtnpn" class="btn btn-primary">Thêm phiếu nhập</button>

                <button type="button" data-dismiss="modal" id="closeBtn">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Danh sách Danh mục-->
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
           <div class="row align-items-center">
    <div class="col-md-8 col-12">
        <h4 class="m-0 font-weight-bold text-primary">Danh sách phiếu nhập</h4>
    </div>
    <div class="col-md-2 col-8 mt-2 mt-md-0">
        <input type="text" id="searchBox" class="form-control" placeholder="Tìm kiếm...">
    </div>
    <div class="col-md-2 col-4 mt-2 mt-md-0 text-md-right">
        <button class="btn btn-primary w-100" data-toggle="modal" data-target="#Themphieunhap">Thêm phiếu nhập</button>
    </div>
</div>
<div class="row mt-3">
                <div class="col-md-4 mb-2">
                    <input type="date" id="startDate" class="form-control" placeholder="Ngày bắt đầu"
                        value="@DateTime.Now.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-4 mb-2">
                    <input type="date" id="endDate" class="form-control" placeholder="Ngày kết thúc"
                        value="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-4 d-flex">
                    <button id="filterButton" class="btn btn-outline-primary mr-2 flex-fill">Lọc</button>
                    <button id="clearFilterButton" class="btn btn-outline-secondary flex-fill">Xóa lọc</button>
                </div>
            </div>
        </div>
        <!--Xem danh sách phiếu-->
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Mã phiếu</th>
                            <th>Tên người nhập</th>
                            <th>Ngày nhập phiếu</th>
                            <th>Xem phiếu</th>
                            <th>Xóa phiếu</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Dữ liệu sẽ được thêm vào bảng tại đây -->
                    </tbody>
                    <tfoot id="pagination">
                    </tfoot>

                </table>
            </div>
        </div>
    </div>
</div>
<!-- Modal hiển thị chi tiết phiếu nhập -->
<div class="modal fade" id="ChiTietPhieuModal" tabindex="-1" role="dialog" aria-labelledby="ChiTietPhieuModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ChiTietPhieuModalLabel">Chi tiết phiếu nhập</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">

                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="chiTietTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Mã hàng</th>
                                <th>Tên hàng</th>
                                <th>Đơn vị tính</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody id="chiTietTableBody">
                            <!-- Dữ liệu chi tiết phiếu sẽ được thêm vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>
        var danhMucList = []; // Array to store category list
        $(document).ready(function () {
            var phieuNhaps = []; // Array to store receipts
            var editingPhieuIndex = -1; // Index for the receipt being edited
            Dsphieunhap(1, 10);

            // Edit button in the receipt modal
            $(document).on('click', '.btnSuaPhieu', function () {
                var maPhieu = $(this).data('phieu');
                var phieu = phieuNhaps.find(p => p.maPhieu === maPhieu);
                $('#tblbodyModalEdit').empty();
                phieu.chiTietPhieu.forEach(function (item) {
                    var chiTietRow = `
                                <tr>
                                    <td>${item.tenHang}</td>
                                    <td>${item.donViTinh}</td>
                                    <td>${item.soLuong}</td>
                                    <td>${item.donGia}</td>
                                    <td><button class="btn btn-danger btnXoaModalEdit">Xóa</button></td>
                                    <td><button class="btn btn-warning btnSuaModalEdit">Sửa</button></td>
                                </tr>`;
                    $('#tblbodyModalEdit').append(chiTietRow);
                });

                // Populate edit form with receipt data
                $('#EditMaDanhmuc').val(phieu.maDanhMuc);
                $('#EditTenDanhmuc').val(phieu.tenDanhMuc);
                $('#EditGia').val(phieu.gia);
                $('#EditSoluong').val(phieu.soLuong);
                $('#EditDonvitinh').val(phieu.donViTinh);
                $('#ChinhSuaPhieuModal').modal('show');
                editingPhieuIndex = phieuNhaps.indexOf(phieu);
            });

<<<<<<< HEAD
=======
            $(document).on('click', '.btnXoaModal', function () {
                var maPhieu = $(this).data('id');
                $(this).closest('tr').remove(); // Xóa dòng tương ứng
                xoaPhieuNhap(maPhieu);

            });
>>>>>>> 2afadeae29ae2d82824f1e9fcd33c1ee5477fd95
            // Xử lý sự kiện khi nhấn nút Xóa trong modal chỉnh sửa
            $(document).on('click', '.btnXoaModalEdit', function () {
                $(this).closest('tr').remove();
            });

            $(document).on('click', '.btnSuaModalEdit', function () {
                var row = $(this).closest('tr');
                $('#EditMaDanhmuc').val(row.find('td:nth-child(1)').text());
                $('#EditTenDanhmuc').val(row.find('td:nth-child(2)').text());
                $('#EditDonvitinh').val(row.find('td:nth-child(3)').text());
                $('#EditSoluong').val(row.find('td:nth-child(4)').text());
                $('#EditGia').val(row.find('td:nth-child(5)').text());
            });

            // Filter categories for editing
            function filterDanhMucListEdit() {
                var searchText = $('#EditTenDanhmuc').val().toLowerCase();
                $('#danhMucListEdit').empty();
                danhMucList.forEach(function (danhMuc) {
                    if (danhMuc.tenDanhMuc.toLowerCase().includes(searchText)) {
                        var item = `<a class="dropdown-item" href="#" data-ten="${danhMuc.tenDanhMuc}">${danhMuc.tenDanhMuc}</a>`;
                        $('#danhMucListEdit').append(item);
                    }
                });
                $('#danhMucListEdit').show();
            }

            // Select category from dropdown
            $(document).on('click', '#danhMucListEdit .dropdown-item', function () {
                var maDanhMuc = $(this).data('ma');
                var tenDanhMuc = $(this).data('ten');
                $('#EditMaDanhmuc').val(maDanhMuc);
                $('#EditTenDanhmuc').val(tenDanhMuc);
                $('#danhMucListEdit').hide();
            });
        });
        // Hàm hiển thị danh sách danh mục
        function showDanhMucList() {
            $('#danhMucList').show();
        }
        // Ẩn danh sách khi nhấp ra ngoài
        $(document).click(function (event) {
            if (!$(event.target).closest('#Ten_danhmuc, #danhMucList').length) {
                $('#danhMucList').hide();
            }
        });
        // Hàm lọc danh mục dựa trên ô input
        function filterDanhMucList() {
            var searchText = $('#Ten_danhmuc').val().toLowerCase();

            $.ajax({
                type: "GET",
                url: "/Danhmuc/Laydanhsachhanghoa",
                success: function (response) {
                    $('#tblbody').empty();
                    if (response.success) {
                        var filteredItems = response.data.filter(function (item) {
                            return item.ten_danhmuc.toLowerCase().includes(searchText);
                        });

                        if (filteredItems.length > 0) {
                            $.each(filteredItems, function (index, value) {
                                var str = `
                                                                                                                                                                                                                                                                            <tr onclick="selectItem('${value.ma_danhmuc}', '${value.ten_danhmuc}', '${value.gia}', '${value.donvitinh}')">
                                                                                                                                                                                                                                                                                <td>${value.ma_danhmuc}</td>
                                                                                                                                                                                                                                                                                <td>${value.ten_danhmuc}</td>
                                                                                                                                                                                                                                                                                <td>${value.donvitinh}</td>
<<<<<<< HEAD
                                                                                                                                                                                                                                                                               <td> $${value.gia}</td>
=======
                                                                                                                                                                                                                                                                               <td> ${value.gia}</td>
>>>>>>> 2afadeae29ae2d82824f1e9fcd33c1ee5477fd95
                                                                                                                                                                                                                                                                            </tr>`;
                                $('#tblbody').append(str);
                            });
                            $('#danhMucList').show();
                        } else {
                            $('#danhMucList').hide();
                        }

                    } else {
                        Swal.fire({
                            title: "Thông báo lỗi",
                            text: response.message,
                            icon: "error"
                        });
                    }
                }
            });
        }
        // Hàm lọc các mục danh mục dựa trên ô tìm kiếm
        function filterTable() {
            var searchText = $('#Ten_danhmuc').val().toLowerCase();
            var rows = $('#tblbody tr');

            rows.each(function () {
                var cells = $(this).find('td');
                var match = false;

                cells.each(function () {
                    if ($(this).text().toLowerCase().includes(searchText)) {
                        match = true;
                    }
                });

                $(this).toggle(match);
            });
        }
        // Thêm sự kiện keyup cho ô tìm kiếm
        $('#Ten_danhmuc').on('keyup', function () {
            filterDanhMucList();
            filterTable();
        });
        // Hàm xử lý khi chọn một mục từ danh sách
        function selectItem(ma_danhmuc, ten_danhmuc, gia, donvitinh) {
            // Gán giá trị cho các input
            $('#Ma_danhmuc').val(ma_danhmuc);
            $('#Ten_danhmuc').val(ten_danhmuc);      // Gán tên danh mục
            $('#Gia').val(gia);                      // Gán giá

            $('#Donvitinh').val(donvitinh);          // Gán đơn vị tính

            // Ẩn danh sách danh mục sau khi chọn
            $('#danhMucList').hide();
        }
        // Ẩn danh sách khi nhấp ra ngoài
        $(document).click(function (event) {
            if (!$(event.target).closest('#Ten_danhmuc, #danhMucList').length) {
                $('#danhMucList').hide();
            }
        });
        $(document).ready(function () {
            var editingModalRowIndex = -1; // Biến để lưu vị trí dòng đang sửa trong modal

            // Handle add to table button in modal
            $('#btnThemVaoBangModal').click(function () {
                var maDanhMuc = $('#Ma_danhmuc').val();
                var tenDanhMuc = $('#Ten_danhmuc').val();
                var gia = $('#Gia').val();
                var soLuong = $('#Soluong').val();
                var donViTinh = $('#Donvitinh').val();
                if (!maDanhMuc || maDanhMuc.trim() === "") {
                    Swal.fire({
                        title: "Thông báo lỗi",
                        text: "Vui lòng chọn ít nhất một mặt hàng để thêm vào phiếu nhập.",
                        icon: "error"
                    });
                    return;
                }
                if (!soLuong || soLuong.trim() === "") {
                    Swal.fire({
                        title: "Thông báo lỗi",
                        text: "Vui lòng nhập số lượng.",
                        icon: "error"
                    });
                    return;
                }
                if (editingModalRowIndex === -1) {
                    var newRow = `
                                <tr>
                                    <td>${maDanhMuc}</td>
                                    <td>${tenDanhMuc}</td>
                                    <td>${donViTinh}</td>
                                    <td>${soLuong}</td>
                                    <td>${formatCurrency(gia)}</td>
                                    <td>${formatCurrency(soLuong * gia)}</td>
                                    <td><button class="btn btn-danger btnXoaModal">Xóa</button></td>
                                    <td><button class="btn btn-warning btnSuaModal">Sửa</button></td>
                                </tr>`;
                    $('#tblbodyModal').append(newRow);
                } else {
                    var row = $('#tblbodyModal tr').eq(editingModalRowIndex);
                    row.find('td:nth-child(1)').text(maDanhMuc);
                    row.find('td:nth-child(2)').text(tenDanhMuc);
                    row.find('td:nth-child(3)').text(donViTinh);
                    row.find('td:nth-child(4)').text(soLuong);
                    row.find('td:nth-child(5)').text(formatCurrency(gia));
                    row.find('td:nth-child(6)').text(formatCurrency(soLuong * gia));
                    editingModalRowIndex = -1;
                }
                $('#NhapHangModal').modal('hide');
            });

            // Format currency
            function formatCurrency(value) {
                return parseFloat(value).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            }

            // Handle add new receipt
            $('#btnThemPhieuNhap').click(function () {
                var data = {
                    maDanhMuc: $('#Ma_danhmuc').val(),
                    tenDanhMuc: $('#Ten_danhmuc').val(),
                    gia: $('#Gia').val(),
                    soLuong: $('#Soluong').val(),
                    donViTinh: $('#Donvitinh').val(),
                    chiTietPhieu: []
                };
                $('#tblbodyModal tr').each(function () {
                    var row = $(this);
                    data.chiTietPhieu.push({
                        maDanhMuc: row.find('td:nth-child(1)').text(),
                        tenDanhMuc: row.find('td:nth-child(2)').text(),
                        donViTinh: row.find('td:nth-child(3)').text(),
                        soLuong: row.find('td:nth-child(4)').text(),
                        gia: row.find('td:nth-child(5)').text()
                    });
                });
                $.ajax({
                    type: "POST",
                    url: "/PhieuNhap/ThemPhieuNhap",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                title: "Thông báo",
                                text: response.message,
                                icon: "success"
                            }).then(() => {
                                Dsphieunhap(1, 10);
                            });
                        } else {
                            Swal.fire({
                                title: "Thông báo lỗi",
                                text: response.message,
                                icon: "error"
                            });
                        }
                    }
                });
            });

            }
            console.log(danhMucList);
        }
        function Dsphieunhap(page, pagesize) {
            $.ajax({
                type: "POST",
                url: "/Phieuxuatkho/Danhsachphieunhapkho",
                data: { page: page, pagesize: pagesize },
                success: function (response) {
                    if (response.success) {
                        $('#dataTableBody').empty();
                        response.dsdm.forEach(function (item) {
                            var row = `
<<<<<<< HEAD
                                <tr>
                                    <td>${item.ma_phieunhapkho}</td>
                                    
                                    <td>${item.nguoinhap}</td>
                                    <td>${item.ngaynhap.split('T')[0]}</td>
                                    <td>
                                        <button class="btn btn-info btnXemPhieu" id="btnXemPhieu" data-id="${item.ma_phieunhapkho}">Xem</button>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btnXoaPhieu" id="btnXoaPhieu" data-id="${item.ma_phieunhapkho}">Xóa</button>
                                    </td>
                                </tr>`;
=======
                                    <tr>
                                        <td>${item.ma_phieunhapkho}</td>
                                        <td>${item.ngaynhap.split('T')[0]}</td>
                                        <td>${item.nguoinhap}</td>
                                        <td>
                                            <button class="btn btn-info" id="btnXemPhieu" data-id="${item.ma_phieunhapkho}">Xem</button>
                                        </td>
                                        <td>
                                            <button class="btn btn-danger" id="btnXoaPhieu" data-id="${item.ma_phieunhapkho}">Xóa</button>
                                        </td>
                                    </tr>`;
>>>>>>> 2afadeae29ae2d82824f1e9fcd33c1ee5477fd95
                            $('#dataTableBody').append(row);
                        });
                        updatePagination(response.totalPages, response.pageindex);
                    } else {
                        Swal.fire({
                            title: "Thông báo lỗi",
                            text: response.message,
                            icon: "error"
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        title: "Lỗi",
                        text: "Đã xảy ra lỗi trong quá trình lấy dữ liệu. Vui lòng thử lại.",
                        icon: "error"
                    });
                }
            });
        }
        $(document).ready(function () {
    // Gọi hàm lọc khi người dùng nhập vào ô tìm kiếm
    $('#searchBox').on('keyup', function () {
        var searchValue = $(this).val().toLowerCase(); // Lấy giá trị từ ô tìm kiếm và chuyển về chữ thường
        $('#dataTableBody tr').filter(function () {
            $(this).toggle($(this).find('td:first').text().toLowerCase().indexOf(searchValue) > -1);
        });
    });
});

            // Load receipts
            function Dsphieunhap(pageNumber, pageSize) {
                $.ajax({
                    type: "GET",
                    url: `/PhieuNhap/GetDanhSach?pageNumber=${pageNumber}&pageSize=${pageSize}`,
                    success: function (response) {
                        $('#tblbodyPhieuNhap').empty();
                        if (response.success) {
                            phieuNhaps = response.data;
                            phieuNhaps.forEach(function (item) {
                                var str = `
                                            <tr>
                                                <td>${item.maPhieu}</td>
                                                <td>${item.tenPhieu}</td>
                                                <td>${item.ngayNhap}</td>
                                                <td><button class="btn btn-warning btnSuaPhieu" data-phieu="${item.maPhieu}">Sửa</button></td>
                                                <td><button class="btn btn-danger btnXoaPhieu" data-id="${item.maPhieu}">Xóa</button></td>
                                            </tr>`;
                                $('#tblbodyPhieuNhap').append(str);
                            });
                            // Update pagination
                            updatePagination(response.pageNumber, response.pageCount);
                        } else {
                            Swal.fire({
                                title: "Thông báo lỗi",
                                text: response.message,
                                icon: "error"
                            });
                        }
                    }
                });
            }

            // Update pagination
            function updatePagination(currentPage, totalPages) {
                $('#pagination').empty();
                for (var i = 1; i <= totalPages; i++) {
                    var pageItem = `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>`;
                    $('#pagination').append(pageItem);
                }
            }

            // Handle pagination click
            $(document).on('click', '#pagination .page-link', function (e) {
                e.preventDefault();
                var pageNumber = $(this).data('page');
                Dsphieunhap(pageNumber, 10);
            });
        });
    </script>
}

